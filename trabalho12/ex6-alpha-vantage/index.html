<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Ações em Paralelo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { padding: 2rem; background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .list-group-item-danger { background-color: #f8d7da; }
    </style>
</head>

<body>
    <main class="container">
        <h1 class="mb-3">Consulta Simultânea de Cotações</h1>
        <p class="lead">Digite os símbolos de três ações (ex: PETR4.SA, MGLU3.SA, ITUB4.SA) e consulte os resultados em paralelo.</p>

        <form id="stockForm">
            <div class="row g-3 align-items-end">
                <div class="col">
                    <label for="symbolInput1" class="form-label">Ação 1</label>
                    <input type="text" class="form-control" placeholder="PETR4.SA" id="symbolInput1" required>
                </div>
                <div class="col">
                    <label for="symbolInput2" class="form-label">Ação 2</label>
                    <input type="text" class="form-control" placeholder="MGLU3.SA" id="symbolInput2" required>
                </div>
                <div class="col">
                    <label for="symbolInput3" class="form-label">Ação 3</label>
                    <input type="text" class="form-control" placeholder="ITUB4.SA" id="symbolInput3" required>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">Consultar Todas</button>
                </div>
            </div>
        </form>

        <div id="results" class="mt-4">
            <h4>Resultados:</h4>
            <ul id="resultsList" class="list-group"></ul>
        </div>
    </main>

    <script>
        // Adiciona um listener para o evento de 'submit' do formulário.
        document.getElementById('stockForm').addEventListener('submit', async function (event) {
            // Previne o comportamento padrão do formulário, que é recarregar a página.
            event.preventDefault();

            // Pega os símbolos dos três campos de input e os armazena em um array.
            const symbols = [
                document.getElementById('symbolInput1').value.trim().toUpperCase(),
                document.getElementById('symbolInput2').value.trim().toUpperCase(),
                document.getElementById('symbolInput3').value.trim().toUpperCase()
            ];
            
            const resultsList = document.getElementById('resultsList');
            // Exibe uma mensagem de carregamento enquanto as cotações são buscadas.
            resultsList.innerHTML = '<li class="list-group-item">Buscando cotações...</li>';

            // Chama a função principal que usa Promise.all para buscar os dados.
            await fetchAllQuotes(symbols);
        });

        // Função assíncrona que busca todas as cotações em paralelo.
        async function fetchAllQuotes(symbols) {
            // A sua chave de API fornecida.
            const apiKey = '8MMBQ1Y2UW3DEGFG';
            const resultsList = document.getElementById('resultsList');

            try {
                // ETAPA 1: Criar um array de Promises.
                // O método .map() itera sobre cada símbolo e retorna uma chamada fetch() para ele.
                // O resultado é um array com 3 Promises de requisição pendentes.
                const promises = symbols.map(symbol => {
                    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`;
                    return fetch(url);
                });

                // ETAPA 2: Executar todas as Promises em paralelo.
                // Promise.all aguarda que TODAS as promises no array sejam resolvidas (ou uma seja rejeitada).
                // As requisições são disparadas simultaneamente para a API.
                const responses = await Promise.all(promises);

                // ETAPA 3: Converter todas as respostas para JSON, também em paralelo.
                // Criamos um novo array de promises, desta vez para a operação .json() de cada resposta.
                const data = await Promise.all(responses.map(response => response.json()));

                // Limpa a mensagem de "Buscando...".
                resultsList.innerHTML = '';
                
                // ETAPA 4: Iterar sobre os dados recebidos para exibir os resultados.
                // O array 'data' contém os resultados na mesma ordem do array 'symbols'.
                data.forEach((quoteData, index) => {
                    const symbol = symbols[index];
                    const quote = quoteData['Global Quote'];
                    const li = document.createElement('li');
                    li.className = 'list-group-item';

                    // Verifica se a API retornou um objeto de cotação válido.
                    if (quote && Object.keys(quote).length > 0) {
                        const price = quote['05. price'];
                        const changePercent = quote['10. change percent'];
                        li.innerHTML = `<strong>${symbol}:</strong> R$ ${price} <span class="badge bg-secondary">${changePercent}</span>`;
                    } else {
                        // Se não encontrou, exibe uma mensagem de erro para aquele símbolo.
                        li.textContent = `Falha ao obter cotação para ${symbol}. Verifique o símbolo ou o limite da API.`;
                        li.classList.add('list-group-item-danger');
                    }
                    resultsList.appendChild(li);
                });

            } catch (error) {
                // Se ocorrer qualquer erro de rede ou na API, exibe uma mensagem geral.
                console.error('Falha na requisição paralela:', error);
                resultsList.innerHTML = `<li class="list-group-item list-group-item-danger">Ocorreu um erro ao buscar as cotações. Verifique sua conexão ou o limite de uso da API.</li>`;
            }
        }
    </script>
</body>

</html>